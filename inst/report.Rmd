---
output: 
  html_document:
    df_print: paged
    self_contained: TRUE
    css: report.css
params:
  df_diff: NULL
  df_orig: NULL
  use_plotly: TRUE
  use_DT: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      rownames.print = FALSE, rows.print = 10,
                      fig.height = 6, fig.width = 9)
knitr::knit_hooks$set(width=local({
    .width <- 0
    function(before, options, envir) {
        if (before) .width <<- options(width=options$width)
        else options(.width)
    }
}))
options(knitr.kable.NA = '')
library(different)
use_DT <- params$use_DT && requireNamespace("DT", quietly = TRUE)
if (use_DT) library(DT)
output_DT <- function(x, filter = "top", ...) {
  htmltools::tagList(DT::datatable(
    x, filter = filter, ..., 
    extensions = 'FixedColumns',
    options = list(
      dom = 'Bfrtip',
      scrollX = TRUE,
      fixedColumns = TRUE
    )))
}
```

```{r diff-from-params, include = FALSE}
df_diff <- params$df_diff
stopifnot(!is.null(df_diff))
```

```{css}
.different-footer {
  display: block;
  position: fixed;
  bottom: 0%;
  left: 30%;
  right: 30%;
  text-align: center;
  background-color: #FFFFFFaa;
}
```

::: {.different-footer}
[different](https://gerkelab.com/project/different)
v`r packageVersion("different")`
:::

# Differences Report {.tabset}

## Summary

:::::: {.panel .panel-info}
::: {.panel-heading}
Differences Report
:::
::: {.panel-body}
__Reference:__ ``r metadata(df_diff)$names["x"]``  
__Comparison:__ ``r metadata(df_diff)$names["y"]``  
__Created:__ `r strftime(Sys.time(), "%F %T %Z")`  
__different:__ v`r packageVersion("different")`
:::
::::::

<details><summary>Input Summary</summary>
```{r summary-dimensions}
purrr::map_dfr(setNames(metadata(df_diff)$dims, metadata(df_diff)$names),
    ~ dplyr::data_frame(Rows = .[1], Columns = .[2]), .id = "Data Set") %>% 
  knitr::kable(format.args = list(big.mark = ",", scientific = FALSE))
```

</details>


<details>
<summary>Differences Summary</summary>

```{r summary-columns}
df_diff %>% 
  select(Column = variable, 
         !! rlang::sym(paste("Type", metadata(df_diff)$names["x"])) := type.x,
         !! rlang::sym(paste("Type", metadata(df_diff)$names["y"])) := type.y,
         `Number of Differences` = n_diff
  ) %>% 
  as_tibble() %>% 
  {
    .x <- .
    type_var <- paste("Type", metadata(df_diff)$names[2])
    if (type_var %in% names(.x)) {
      type_var_y <- rlang::sym(type_var)
      type_var_x <- rlang::sym(paste("Type", metadata(df_diff)$names[1]))
      dplyr::mutate(
        .x, 
        !!type_var_y := ifelse(!is.na(!!type_var_y) & !is.na(!!type_var_x) & !!type_var_y != !!type_var_x, 
                               paste0('<span style="color: red">', !!type_var_y, "</span>"), 
                               !!type_var_y))
    } else .x
  } %>% 
  dplyr::mutate_at(
    dplyr::vars(dplyr::starts_with("Type")),
    function(x) ifelse(is.na(x), "\U274C", x)
  ) %>% 
  knitr::kable(escape = FALSE)
```

</details>

<details>
<summary>Session Info</summary>

```{r summary-session-info, comment="", max.print=150}
old_opts <- options(max.print = 500)
if (requireNamespace("sessioninfo", quietly = TRUE)) {
  sessioninfo::session_info()
} else sessionInfo()
options(old_opts)
```

</details>

## Visualization

```{r visualization, out.width="100%"}
if (params$use_plotly && requireNamespace("plotly", quietly = TRUE)) {
  plotly::ggplotly(plot(df_diff))
} else {
  plot(df_diff)
}
```

## Differences by Column {.tabset .tabset-fade .tabset-pills}

```{r diffs-by-column, include=FALSE}
diff <- df_diff %>% filter(state == "diff") %>% 
  select(variable, diff) %>% 
  split(.$variable) %>% 
  purrr::map(~ tidyr::unnest(.))
out <- vector(mode = "character", length = length(diff))
for (colname in names(diff)) {
  out[[colname]] <- knitr::knit_expand(
    text = c(
      "### {{colname}}",
      "```{r, echo = FALSE}",
      "x <- diff[['{{colname}}']]",
      "colnames(x)[2:3] <- metadata(df_diff)$names",
      "if (use_DT) output_DT(x) else x",
      "```\n\n")
  )
}
```

`r paste(knitr::knit(text = out), collapse = "\n")`

```{r original-data, include=FALSE}
if (!is.null(params$df_orig) && !all(purrr::map_lgl(params$df_orig, is.null))) {
  orig_knit_chunks <- knitr::knit_expand(
    text = c(
      "## Original: {{metadata(df_diff)$names['x']}}",
      "",
      "```{r, echo=FALSE, out.width='100%'}",
      "if (use_DT) output_DT(params$df_orig$x) else params$df_orig$x",
      "```\n\n",
      "", 
      "## Original: {{metadata(df_diff)$names['y']}}",
      "",
      "```{r, echo=FALSE, out.width='100%'}",
      "if (use_DT) output_DT(params$df_orig$y) else params$df_orig$y",
      "```\n\n"
    )
  )
} else orig_knit_chunks <- ""
```

`r paste(knitr::knit(text = orig_knit_chunks), collapse = "\n")`
