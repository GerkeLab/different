---
output: 
  html_document:
    df_print: paged
    self_contained: TRUE
    css: report.css
params:
  df_diff: NULL
  df_orig: NULL
  use_plotly: TRUE
  use_DT: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      rownames.print = FALSE, rows.print = 10,
                      fig.height = 6, fig.width = 9)
knitr::knit_hooks$set(width=local({
    .width <- 0
    function(before, options, envir) {
        if (before) .width <<- options(width=options$width)
        else options(.width)
    }
}))
options(knitr.kable.NA = '')
library(different)
use_DT <- params$use_DT && requireNamespace("DT", quietly = TRUE)
if (use_DT) library(DT)
output_DT <- function(x, filter = "top", ...) {
  htmltools::tagList(DT::datatable(
    x, filter = filter, ..., 
    extensions = 'FixedColumns',
    options = list(
      dom = 'Bfrtip',
      scrollX = TRUE,
      fixedColumns = TRUE
    )))
}
```

```{r diff-from-params, include = FALSE}
stopifnot(!is.null(df_diff))
df_diff <- params$df_diff
```

<style>
.different-footer {
  display: block;
  position: fixed;
  bottom: 0%;
  left: 30%;
  right: 30%;
  text-align: center;
  background-color: #FFFFFFaa;
}
</style>

<div class="different-footer">
[different](https://gerkelab.com/project/different)
v`r packageVersion("different")`
</div>

# Differences Report {.tabset}

## Summary

<div class="panel panel-info">
<div class="panel-heading">Differences Report</div>
<div class="panel-body">
__Reference:__ ``r df_diff$meta$names["x"]``  
__Comparison:__ ``r df_diff$meta$names["y"]``  
__Created:__ `r strftime(Sys.time(), "%F %T %Z")`  
__different:__ v`r packageVersion("different")`
</div>
</div>

<details><summary>Input Summary</summary>
```{r summary-dimensions}
purrr::map_dfr(setNames(df_diff$meta$dims, df_diff$meta$names),
    ~ dplyr::data_frame(Rows = .[1], Columns = .[2]), .id = "Data Set") %>% 
  knitr::kable(format.args = list(big.mark = ",", scientific = FALSE))
```

</details>


<details>
<summary>Differences Summary</summary>

```{r summary-columns}
purrr::map2(
  df_diff$meta$colnames, 
  df_diff$meta$coltypes, 
  ~ dplyr::data_frame(Column = .x, Type = .y)
) %>% 
  purrr::reduce(
    full_join, 
    suffix = paste("", c(df_diff$meta$names[1], df_diff$meta$names[2])),
    by = "Column"
  ) %>% 
  {
    .x <- .
    type_var <- paste("Type", df_diff$meta$names[2])
    if (type_var %in% names(.x)) {
      type_var_y <- rlang::sym(type_var)
      type_var_x <- rlang::sym(paste("Type", df_diff$meta$names[1]))
      dplyr::mutate(
        .x, 
        !!type_var_y := ifelse(!is.na(!!type_var_y) & !is.na(!!type_var_x) & !!type_var_y != !!type_var_x, 
                               paste0('<span style="color: red">', !!type_var_y, "</span>"), 
                               !!type_var_y))
    } else .x
  } %>% 
  dplyr::mutate_at(
    dplyr::vars(dplyr::starts_with("Type")),
    function(x) ifelse(is.na(x), "\U274C", x)
  ) %>% 
  left_join(df_diff$diff[, c("variable", "miss_count")], by = c(Column = "variable")) %>% 
  rename(`Number of Differences` = miss_count) %>% 
  knitr::kable(escape = FALSE, )
```

</details>

<details>
<summary>Session Info</summary>

```{r summary-session-info, comment="", max.print=150}
old_opts <- options(max.print = 500)
if (requireNamespace("sessioninfo", quietly = TRUE)) {
  sessioninfo::session_info()
} else sessionInfo()
options(old_opts)
```

</details>

## Visualization

```{r visualization, out.width="100%"}
if (params$use_plotly && requireNamespace("plotly", quietly = TRUE)) {
  plotly::ggplotly(plot(df_diff))
} else {
  plot(df_diff)
}
```

## Differences by Column {.tabset .tabset-fade .tabset-pills}

```{r diffs-by-column, include=FALSE}
out <- vector(mode = "character", length = length(df_diff$tidy))
for (colname in names(df_diff$tidy)) {
  out[[colname]] <- knitr::knit_expand(
    text = c(
      "### {{colname}}",
      "```{r, echo = FALSE}",
      "x <- df_diff$tidy[['{{colname}}']]",
      "colnames(x)[2:3] <- df_diff$meta$names",
      "if (use_DT) output_DT(x) else x",
      "```\n\n")
  )
}
```

`r paste(knitr::knit(text = out), collapse = "\n")`

```{r original-data, include=FALSE}
if (!is.null(params$df_orig)) {
  orig_knit_chunks <- knitr::knit_expand(
    text = c(
      "## Original: {{df_diff$meta$names['x']}}",
      "",
      "```{r, echo=FALSE, out.width='100%'}",
      "if (use_DT) output_DT(params$df_orig$ref) else params$df_orig$ref",
      "```\n\n",
      "", 
      "## Original: {{df_diff$meta$names['y']}}",
      "",
      "```{r, echo=FALSE, out.width='100%'}",
      "if (use_DT) output_DT(params$df_orig$cmp) else params$df_orig$cmp",
      "```\n\n"
    )
  )
} else orig_knit_chunks <- ""
```

`r paste(knitr::knit(text = orig_knit_chunks), collapse = "\n")`
